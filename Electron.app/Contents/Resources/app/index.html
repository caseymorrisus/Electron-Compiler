<!DOCTYPE html>
<html>
  <head>
    <title>Casey</title>
    <link href='http://fonts.googleapis.com/css?family=Lobster' rel='stylesheet' type='text/css'>
    <link href='http://fonts.googleapis.com/css?family=Ultra' rel='stylesheet' type='text/css'>
    <link href='http://fonts.googleapis.com/css?family=Stint+Ultra+Expanded' rel='stylesheet' type='text/css'>
    <link href='http://fonts.googleapis.com/css?family=Slabo+13px' rel='stylesheet' type='text/css'>

	<link rel="stylesheet" href="reset.css">
    <link rel="stylesheet" type="text/css" href="style.css">
   	<script src="jquery.js"></script>
   	
  </head>
  <body>
  	<div class="background"></div>
  	<div class="status-bar">
  		<span class="logo">
			<img src="img/dudeman.png">
  		</span>

  		<span class="minimize" id="minimize">
			<svg id="svg2" viewBox="0 0 10 3.0000001" height="3" width="10">
			  <g transform="translate(-106.64286,-1017.0051)" id="layer1">
			    <rect y="980.93365" x="107.14286" height="55.714287" width="45.714298" id="rect3336" style="fill:#ffffff;fill-rule:evenodd;stroke:#ffffff;stroke-width:1px;stroke-linecap:butt;stroke-linejoin:miter;stroke-opacity:1" />
			  </g>
			</svg>

  		</span>
  		<span class="maximize" id="maximize">
			<svg id="svg2" viewBox="0 0 15 10" height="10" width="15">
			  <g transform="translate(-106.64286,-1010.0051)" id="layer1">
			    <rect y="1010.12" x="100.36" height="2.77" width="46.49" id="rect3336" style="fill-rule:evenodd;fill:#fff;stroke-width:0.23;stroke:#fff"/>
			    <rect transform="matrix(0,1,-1,0,0,0)" y="-109.53" x="1000.17" height="2.77" width="46.49" id="rect3336-0" style="fill-rule:evenodd;fill:#fff;stroke-width:0.23;stroke:#fff"/>
			    <rect transform="matrix(0,1,-1,0,0,0)" y="-121.53" x="997.9" height="2.77" width="46.49" id="rect3336-0-9" style="fill-rule:evenodd;fill:#fff;stroke-width:0.23;stroke:#fff"/>
			    <rect y="1017.12" x="93.76" height="2.77" width="46.49" id="rect3336-4" style="fill-rule:evenodd;fill:#fff;stroke-width:0.23;stroke:#fff"/>
			  </g>
			</svg>
  		</span>
  		<span class="fullscreen" id="fullscreen">
			<svg height="15px" style="enable-background:new 0 0 32 32;" version="1.1" viewBox="0 0 32 32" width="15px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><g id="Layer_1"/><g id="fullscreen"><g><polygon points="27.414,24.586 22.828,20 20,22.828 24.586,27.414 20,32 32,32 32,20   " style="fill:#ffffff;"/><polygon points="12,0 0,0 0,12 4.586,7.414 9.129,11.953 11.957,9.125 7.414,4.586   " style="fill:#ffffff;"/><polygon points="12,22.828 9.172,20 4.586,24.586 0,20 0,32 12,32 7.414,27.414   " style="fill:#ffffff;"/><polygon points="32,0 20,0 24.586,4.586 20.043,9.125 22.871,11.953 27.414,7.414 32,12   " style="fill:#ffffff;"/></g></g></svg>
  		</span>
  		<span class="close" id="close">
  			<svg enable-background="new 0 0 24 24" height="24px" id="Layer_1" version="1.1" viewBox="0 0 24 24" width="24px" xml:space="preserve"><path d="M22.245,4.015c0.313,0.313,0.313,0.826,0,1.139l-6.276,6.27c-0.313,0.312-0.313,0.826,0,1.14l6.273,6.272  c0.313,0.313,0.313,0.826,0,1.14l-2.285,2.277c-0.314,0.312-0.828,0.312-1.142,0l-6.271-6.271c-0.313-0.313-0.828-0.313-1.141,0  l-6.276,6.267c-0.313,0.313-0.828,0.313-1.141,0l-2.282-2.28c-0.313-0.313-0.313-0.826,0-1.14l6.278-6.269  c0.313-0.312,0.313-0.826,0-1.14L1.709,5.147c-0.314-0.313-0.314-0.827,0-1.14l2.284-2.278C4.308,1.417,4.821,1.417,5.135,1.73  L11.405,8c0.314,0.314,0.828,0.314,1.141,0.001l6.276-6.267c0.312-0.312,0.826-0.312,1.141,0L22.245,4.015z"/></svg>
  		</span>
  		<span class="status-bar-controls"></span>
  	</div>
  	<span class="status-menu-controls"></span>
  	<div class="status-menu">
  		<span class="file" id="file">File</span>
  		<span class="edit" id="edit">Edit</span>
  		<span class="help" id="edit">Help</span>
  	</div>
  	<div class="container">
		<div class="left-column">
			<div id="holder">
				<strong>Drag your project directory here.</strong>
			</div>
			<h3><strong>File Types Watched</strong></h3>
			<ul class="filetypes">

			</ul>
		</div>
		<div class="right-column">
			<h1><strong>Compile Log</strong></h1>
			<ul id="compile-log">

			</ul>
		</div>


		<script>
			window.jQuery = require('jquery.js');
			var fs = require("fs");
			var ipc = require('ipc');
			var pathlib = require('path');
			var gaze = require('gaze');
			// COMPILE LIBRARIES //
			var jade = require('jade');
			var shell = require('shelljs');
			var csswring = require('csswring');
			var chokidar = require('chokidar');
			var less = require('less');
			var devmode = true;

			var appdirectory = ipc.sendSync('get-directory');
			console.log("\n\nGOT DIRECTORY: " + appdirectory + "\n\n");


			// IF DEVMODE WATCH DEV FOLDER AND LIVE RELOAD //

			if (devmode) {
				gaze(appdirectory + '/*.*', function(err, watcher) {
					this.on('changed', function(filepath) {
						console.log("File changed.");
						ipc.send('reload');
					});
				});
			}

			// END OF DEVMODE WATCHER
			
			try {
				var directorypath = '' + fs.readFileSync(appdirectory + '/.directory') + '';
				$('#holder').text('');
				$('#holder').append('<strong>Currently Watching:</strong><br>').append(directorypath);
				ipc.send('directory-path', directorypath);
			} catch(err) {
				console.log("No directory set yet.");
			}

			

			console.log('DIRECTORY FILE CONTENTS: ' + directorypath);
			var holder = document.getElementById('holder');
			holder.ondragover = function () {
				return false;
			};
		    holder.ondragleave = holder.ondragend = function () {
				return false;
			};
			holder.ondrop = function (e) {
			  e.preventDefault();
			  var file = e.dataTransfer.files[0];
			  console.log('File you dragged here is' + file.path);
			  fs.writeFileSync(appdirectory + '/.directory', file.path);
			  ipc.send('reload');
			  return false;
		  };
		</script>
	</div>
	<script>
		console.log('DIRECTORY FILE CONTENTS AGAIN: ' + directorypath);
		var pathlib = require('path'),
		    jade = require('jade'),
		    shell = require('shelljs'),
		    csswring = require('csswring'),
		    chokidar = require('chokidar'),
		    less = require('less'),
		    coffee = require('coffee-script'),
		    tsc = require('typescript-compiler'),
		    UglifyJS = require('uglify-js');
		//var sass = require('ruby-sass');

		var options = {
			minify: 	true 
		};

		var watched_files = {
			cssmin: 		'*.css',
			scss: 			'*.scss',
			less: 			'*.less',
			styl: 			'*.styl',
			jade: 			'*.jade',
			html: 			'*.html',
			coffee: 		'*.coffee',
			typescript: 	'*.ts',
			jsmin: 			"*.js"
		};

		$.each( watched_files, function(key, value) {
			$('.filetypes').append('<li>' + key + '</li>');
		});

		var log = $('#compile-log');
		function addLog(compiled, message) {
			if (compiled) {
				log.prepend('<li>Compiled: ' + message + '</li>');
			}
		}

		$.each( watched_files, function(key, value) {
			//console.log( key + ": " + value + '\n');
			switch(key) {
				case 'cssmin':
					if(options.minify) {
						gaze([value, '!*.min*'],{cwd: directorypath}, function(err, watcher) {
							function compileCss(filepath) {
								console.log("\n\nCSS FILE WAS ADDED.\n\n")
								var fileName = pathlib.basename(filepath, '.css');
								var fileDir = pathlib.dirname(filepath);
								shell.cd(directorypath);
								var css = fs.readFileSync(filepath, 'utf8');
								fs.writeFileSync(fileDir + '/' + fileName + '.min.css', csswring.wring(css).css);
								//ipc.send('reload');
								addLog(true, filepath);
							}
							this.on('changed', function(filepath) {
								compileCss(filepath);
							});
							this.on('added', function(filepath) {
								compileCss(filepath);
							});
						});
					}
					break;
				case 'scss':
					gaze(value,{cwd: directorypath}, function(err, watcher) {
						function compileScss(filepath) {
							console.log("SCSS / SASS File Changed");
							var fileName = pathlib.basename(filepath, '.scss');
							var fileDir = pathlib.dirname(filepath);
							shell.cd(directorypath);
							shell.exec('node-sass ' + directorypath + '/' + fileName + '.scss ' + directorypath + '/' + fileName + '.css', {async: true}, function(code, output) {
								if(code == 0) {
									addLog(true, filepath);
									if(options.minify) {
										var css = fs.readFileSync(filepath, 'utf8');
										fs.writeFileSync(fileDir + '/' + fileName + '.min.css', csswring.wring(css).css);
									}
									//ipc.send('reload');
								} else {
									console.log("Please install Node-Sass using npm install -g node-sass");
								}
							});
						}
						this.on('changed', function(filepath) {
							compileScss(filepath);
						});
						this.on('added', function(filepath) {
							compileScss(filepath);
						});
					});
					break;
				case 'less':
					gaze(value,{cwd: directorypath}, function(err, watcher) {
						function compileLess(filepath) {
							var fileName = pathlib.basename(filepath, '.less');
							var fileDir = pathlib.dirname(filepath);
							less.render(fs.readFileSync(filepath).toString(), {
								filename: pathlib.resolve(filepath),
							}, function(e,output) {
								fs.writeFileSync(fileDir + '/' + fileName + '.css', output.css);
							});
							addLog(true, filepath);
							if(options.minify) {
								var css = fs.readFileSync(filepath, 'utf8');
								fs.writeFileSync(fileDir + '/' + fileName + '.min.css', csswring.wring(css).css);
							}
						}
						this.on('changed', function(filepath) {
							compileLess(filepath);
						});
						this.on('added', function(filepath) {
							compileLess(filepath);
						});
					})
					break;
				case 'styl':
					gaze(value,{cwd: directorypath}, function(err, watcher) {
						function compileStyl(filepath) {
							var fileName = pathlib.basename(filepath, '.styl');
							var fileDir = pathlib.dirname(filepath);
							shell.cd(fileDir);
							shell.exec('stylus ' + fileName + '.styl', {async: true}, function(code, output) {
								if(code == 0) {
									addLog(true, filepath);
									//ipc.send('reload');
									if(options.minify) {
										var css = fs.readFileSync(filepath, 'utf8');
										fs.writeFileSync(fileDir + '/' + fileName + '.min.css', csswring.wring(css).css);
									}
								} else {
									console.log("Please install Stylus using npm install -g stylus");
								}
							});
						}
						this.on('changed', function(filepath) {
							compileStyl(filepath);
						});
						this.on('added', function(filepath) {
							compileStyl(filepath);
						});
					})
					break;
				case 'jade':
					gaze(value,{cwd: directorypath}, function(err, watcher) {
						function compileJade(filepath) {
							var fileName = pathlib.basename(filepath, '.jade');
							var fileDir = pathlib.dirname(filepath);
							console.log("JADE File Changed");
							shell.cd(fileDir);
							shell.exec('jade ' + fileName + '.jade', {async: true}, function(code, output) {
								if(code == 0) {
									addLog(true, filepath);
									//ipc.send('reload');
								} else {
									console.log("Please install Jade using npm install -g jade");
								}
							});
						}
						this.on('changed', function(filepath) {
							compileJade(filepath);
						});
						this.on('added', function(filepath) {
							compileJade(filepath);
						});
					})
					break;
				case 'html':
					gaze(value,{cwd: directorypath}, function(err, watcher) {
						this.on('all', function(filepath) {
							
						});
					})
					break;
				case 'coffee':
					gaze(value,{cwd: directorypath}, function(err, watcher) {
						function compileCoffee(filepath) {
							console.log("COFFEE File Changed");
							var fileName = pathlib.basename(filepath, '.coffee');
							var fileDir = pathlib.dirname(filepath);
							shell.cd(directorypath);
							var rawCoffee = fs.readFileSync(filepath, 'utf8');
							var brewedCoffee = coffee.compile(rawCoffee);
							fs.writeFileSync(fileDir + '/' + fileName + '.js', brewedCoffee)
							addLog(true, filepath);
						}
						this.on('changed', function(filepath) {
							compileCoffee(filepath);
						});
						this.on('added', function(filepath) {
							compileCoffee(filepath);
						});
					});
					break;
				case 'typescript':
					gaze(value, {cwd: directorypath}, function(err, watcher) {
						function compileTs(filepath) {
							console.log("TYPESCRIPT File Changed");
							var fileName = pathlib.basename(filepath, '.ts');
							var fileDir = pathlib.dirname(filepath);
							var ts = fs.readFileSync(filepath, 'utf8');
							var js = tsc.compileString(ts);
							console.log(js);
							fs.writeFileSync(fileDir + '/' + fileName + '.js', js);
							addLog(true, filepath);
							//tsc.compile(fileName + '.ts', ['--out', fileName + '.js']);
							//addLog(true, filepath);
						}
						this.on('changed', function(filepath) {
							compileTs(filepath);
						});
						this.on('added', function(filepath) {
							compileTs(filepath);
						});
					});
					break;
				case 'jsmin':
					gaze([value, '!*.min*'], {cwd: directorypath}, function(err, watcher) {
						function minifyJs(filepath) {
							console.log("JAVASCRIPT File Changed");
							var fileName = pathlib.basename(filepath, '.ts');
							var fileDir = pathlib.dirname(filepath);
							var minJs = UglifyJS.minify(filepath);
							fs.writeFileSync(fileDir + '/' + fileName + '.min.js', minJs.code);
							addLog(true, filepath);
						}
						this.on('changed', function(filepath) {
							minifyJs(filepath);
						});
						this.on('added', function(filepath) {
							minifyJs(filepath);
						});
					});
					
					break;
			}

		});
		

		

		var closeBtn = document.getElementById('close');
		closeBtn.addEventListener('click', function() {
			ipc.send('close-window');
		});

		var minimizeBtn = document.getElementById('minimize');
		minimizeBtn.addEventListener('click', function() {
			ipc.send('min-window');
		});

		var maximizeBtn = document.getElementById('maximize');
		maximizeBtn.addEventListener('click', function() {
			ipc.send('max-window');
		});

		var fullBtn = document.getElementById('fullscreen');
		fullBtn.addEventListener('click', function() {
			ipc.send('kiosk-window');
		});
  	</script>
  	<script>
		var remote = require('remote');
		var Menu = remote.require('menu');
		var MenuItem = remote.require('menu-item');

		var menu = new Menu();
		menu.append(new MenuItem({ 
			label: 'Exit',
			sublabel: 'Close The Application',
			click: function() { ipc.send('close-window'); }
			
		}));
		var fileBtn = document.getElementById('file');
		fileBtn.addEventListener('click', function (e) {
		  e.preventDefault();
		  menu.popup(remote.getCurrentWindow());
		}, false);
	</script>
	<script>

	</script>
  </body>
</html>